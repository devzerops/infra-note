# baremetal로 Proxmox로 옮긴 이유

## 1.안정성 문제

## 2. 리소스 문제

## 3. 하드웨어 제약

![realtec ESXI 호환에러](https://svrforum.com/files/attach/images/2023/01/01/04786d55512cc226a777606c54fbf687.jpg)  
(출처: 서버포럼)


# proxmox homelab 장점
1. 비용의 제약에서 상당부분 해소
2. debian 기반 시스템으로 리눅스 베이스이기에 자동화 하는데 장벽이 낮음
3. ESXI에서 비용문제로 사용할수없는 기능을 사용가능
4. 하드웨어의 제약에서 상당부분 해소됨

# 넘어가면서 생긴 문제점
ESXI로 진행한 프로젝트를 숙련도와 저장장치의 제한으로 쉽게 이동할수 없었다. 
그렇기에 보험을 남겨놔야 했었는데 그게 핵심 설정파일들이었다. 
그렇기에 아에 처음부터 재설치를 하되 남길수있는 설정파일만 남기고 복구를 빠르게 시킬수있게 핵심 파일만 백업하고 넘어가기로 했다.  
아래 파일들은 무엇보다 용량자체가 많아봐야 1기가도 안되기에 노트북으로 데이터를 넘기고 다시 proxmox로 넘기는데 무리가 없었다.
1. PFsense Config
2. ansible yaml 설정파일
3. kubespray 설정파일
4. kubernetes yaml 설정파일

물론 vm 자체를 옮기면 되는게 베스트였기에 노트북에 핵심파일만 따로 백업해서 googledrive에 이중백업 시켜놓고 vm을 노트북에 백업시킬려했다.  
제한사항은 아래와 같다.
1. 디스크 용량의 제한
2. 숙련도 이슈
3. proxmox의 무지
이로 인하여 어떻게 백업해야하는지 감이 안잡혔는데 이제와서 생각해보면 아래와 같이 했으면 됐었다.
기본적으로 esxi에서 vm을 ova로 백업하고 그걸 proxmox에서 사용가능한 vm으로 컨버팅 시킨다음에 proxmox에 옮기면 되는데 
디스크 제약과 실수로 인하여 날려먹어서 복구가 불가능했다.  


# proxmox에서 가상 L3 스위치 만들기
여기에서 정말 많이 막혔다.  
기본적으로 이와 관련된 자료를 찾기 힘들기에 많이 고생한거같았다. 결론적으로는 OVS를 이용하여 VLAN 태킹을 하고
OVS VLAN 포트의 트래픽을 SPAN 시킨 방식으로 진행했다.  




SIEM에는 SPAN포트를 붙여서 suricata와 ZEEK를 사용한 구조를 사용했었는데  
여기는 포트 자체를 붙일수 없기에 hookscript를 이용하여 vm을 실행할떄 SPAN역할을 해주는 기능을 붙여주는 구조를 사용하였다. 

``` bash
qm set 6000 --hookscript local:snippets/port-mirror.sh
```


